<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>üìä Dashboard ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏≠‡∏°‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background: #f4f6f9;
      font-family: 'Sarabun', sans-serif;
      padding: 20px;
    }
    .container-custom {
      max-width: 1300px;
      margin: auto;
    }
    canvas {
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .card-control {
      padding: 20px;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    h1, h4 {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
<div class="container container-custom">
  <h1 class="text-center">üìä Dashboard ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏≠‡∏°‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</h1>

  <!-- Filter Control -->
  <div class="card-control">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">üìå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏û‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á</label>
        <select class="form-select" id="filterSelect">
          <option value="all" selected>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="3">3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏û‡∏á‡∏™‡∏∏‡∏î</option>
          <option value="5">5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏û‡∏á‡∏™‡∏∏‡∏î</option>
          <option value="10">10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏û‡∏á‡∏™‡∏∏‡∏î</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">üìä ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏£‡∏≤‡∏ü</label>
        <select class="form-select" id="chartTypeSelect">
          <option value="bar" selected>‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô)</option>
          <option value="line">‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô</option>
          <option value="pie">‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏°</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="mb-5">
    <canvas id="tuitionChart" height="100"></canvas>
  </div>

  <!-- Table -->
  <table id="costTable" class="table table-striped table-bordered">
    <thead class="table-dark">
    <tr>
      <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
      <th>‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢</th>
      <th>‡∏Ñ‡∏ì‡∏∞</th>
      <th>‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</th>
      <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ö‡∏≤‡∏ó)</th>
    </tr>
    </thead>
    <tbody>
    {% for row in data %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ row['‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢'] }}</td>
        <td>{{ row['‡∏Ñ‡∏ì‡∏∞'] }}</td>
        <td>{{ row['‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£'] }}</td>
        <td class="{% if row['‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)'] > 40000 %}text-danger fw-bold
                    {% elif row['‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)'] < 20000 %}text-success fw-bold{% endif %}">
          {{ row['‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó, ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•)'] }}
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
  const rawData = {{ data | tojson }};
  let chartInstance = null;

  const initTable = () => {
    $('#costTable').DataTable({
      language: {
        search: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:",
        lengthMenu: "‡πÅ‡∏™‡∏î‡∏á _MENU_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤",
        zeroRecords: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
        info: "‡πÅ‡∏™‡∏î‡∏á _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å _TOTAL_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
        infoEmpty: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
        infoFiltered: "(‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î _MAX_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)"
      }
    });
  };

  const renderChart = () => {
    const filter = document.getElementById('filterSelect').value;
    const chartType = document.getElementById('chartTypeSelect').value;

    let filteredData = [...rawData];
    if (filter !== 'all') {
      const topN = parseInt(filter);
      if (!isNaN(topN)) {
        filteredData = filteredData
          .sort((a, b) => b["‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)"] - a["‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)"])
          .slice(0, topN);
      }
    }

    const labels = filteredData.map(row => row["‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢"]);
    const values = filteredData.map(row => row["‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)"]);

    const config = {
      type: chartType,
      data: {
        labels: labels,
        datasets: [{
          label: '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ö‡∏≤‡∏ó)',
          data: values,
          backgroundColor: chartType === 'pie' ? [
            '#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1'
          ] : 'rgba(0, 123, 255, 0.6)',
          borderColor: chartType === 'pie' ? '#fff' : 'rgba(0, 123, 255, 1)',
          borderWidth: 1,
          tension: 0.3
        }]
      },
      options: {
        indexAxis: chartType === 'bar' ? 'y' : 'x',
        responsive: true,
        plugins: {
          legend: { display: chartType === 'pie' },
          tooltip: {
            callbacks: {
              label: function(context) {
                if (context.raw && typeof context.raw === 'number') {
                  return `${context.label}: ${context.raw.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
                }
                if (context.parsed && typeof context.parsed.y === 'number') {
                  return `${context.label}: ${context.parsed.y.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
                }
                return '';
              }
            }
          }
        },
        scales: chartType !== 'pie' ? {
          x: {
            beginAtZero: true,
            title: { display: true, text: '‡∏ö‡∏≤‡∏ó' }
          },
          y: {
            title: { display: true, text: '‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢' }
          }
        } : {}
      }
    };

    if (chartInstance) chartInstance.destroy();
    const ctx = document.getElementById('tuitionChart').getContext('2d');
    chartInstance = new Chart(ctx, config);
  };

  $(document).ready(function () {
    initTable();
    renderChart();
    $('#filterSelect, #chartTypeSelect').on('change', renderChart);
  });
</script>

</body>
</html>
